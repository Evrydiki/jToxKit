!function(t,e,i){t.ui=e.extend(t.ui,{templates:{},fillTemplate:function(e,n){return i(t.ui.formatString(i(e).html(),n).replace(/(<img(\s+.*)?)(\s+jt-src=")/,'$1 src="'))},updateCounter:function(t,e,i){var n=null,s="";return null==e&&(e=0),null==i?(n=/\(([\d\?]+)\)$/,s=""+e):(n=/\(([\d\?]+\/[\d\?\+-]+)\)$/,s=""+e+"/"+i),t.match(n)?t=t.replace(n,"("+s+")"):t+=" ("+s+")",t},enterBlur:function(t){13==t.keyCode&&this.blur()},fixBaseUrl:function(t){return null!=t&&"/"==t.charAt(t.length-1)&&(t=t.slice(0,-1)),t},grabBaseUrl:function(t,e){if(null!=t){if(e)return t.slice(0,t.indexOf("/"+e));if(0==t.indexOf("http"))return this.formBaseUrl(this.parseURL(t))}return this.settings.baseUrl},formBaseUrl:function(t){var e=t.host?t.protocol+"://"+t.host+(t.port.length>0?":"+t.port:"")+"/"+t.segments[0]:null;return console.log("Deduced base URL: "+e+" (from: "+t.source+")"),e},copyToClipboard:function(t,e){e||(e="Press Ctrl-C (Command-C) to copy and then Enter."),window.prompt(e,t)}}),t.ui=e.extend(t.ui,{rootSettings:{},kitsMap:{},templateRoot:null,callId:0,initKit:function(n){var s=this,a=n.data(),r=a.kit,o=i.extend(!0,{},s.rootSettings);parent=null,e.each(n.parents(".jtox-kit,.jtox-widget").toArray().reverse(),function(t){parent=s.kit(t),null!=parent&&(o=i.extend(!0,o,parent))}),parent||(parent=s),a=i.extend(!0,o,a),a.baseUrl=s.fixBaseUrl(a.baseUrl),a.target=n,void 0===a.id&&(a.id=n.attr("id"));var l=function(e,i){if(!r)return null;var n=window[r];"function"!=typeof n&&(r=r.charAt(0).toUpperCase()+r.slice(1),n=t[r]);var o=null;return"function"==typeof n?o=new n(e):"object"==typeof n&&"function"==typeof n.init&&(o=n.init(e)),null!=o?(void 0===n.prototype.__kits&&(n.prototype.__kits=[]),n.prototype.__kits.push(o),o.parentKit=parent,null!==a.id&&(s.kitsMap[a.id]=o)):console.log("jToxError: trying to initialize unexistent jTox kit: "+r),o};if(null!=a.configFile)i.ajax({settings:"GET",url:a.configFile},function(t){t&&i.extend(!0,a,t),n.data("jtKit",l(a))});else{if("string"==typeof a.configuration&&window[a.configuration]){var h=window[a.configuration];i.extend(!0,a,"function"==typeof h?h.call(r,a,r):h)}n.data("jtKit",l(a,n))}},initialize:function(t){var e=this;if(!t){e.initTemplates(),i(document).on("click",".jtox-kit span.ui-icon-copy",function(){return this.copyToClipboard(i(this).data("uuid")),!1}),i(document).on("click",".jtox-foldable>.title",function(t){i(this).parent().toggleClass("folded")}),i(document).on("click",".jtox-diagram span.ui-icon",function(){i(this).toggleClass("ui-icon-zoomin").toggleClass("ui-icon-zoomout"),i("img",this.parentNode).toggleClass("jtox-smalldiagram")});var n=this.parseURL(document.location),s=n.params;e.rootSettings.baseUrl?s.baseUrl&&(s.baseUrl=e.fixBaseUrl(s.baseUrl)):s.baseUrl=e.formBaseUrl(n),e.rootSettings=i.extend(!0,e.rootSettings,s),e.fullUrl=n,t=document}var a=function(){i(this).data("manualInit")||e.initKit(i(this))};i(".jtox-kit",t).each(a),i(".jtox-widget",t).each(a)},kit:function(t){return"string"!=typeof t?i(t).data("jtKit"):void 0!==this.kitsMap[t]?this.kitsMap[t]:i("#"+t).data("jtKit")},attachKit:function(t,e){return i(t).data("jtKit",e)},parentKit:function(t,e){var n=this,s=null;return"string"==typeof t&&(t=window[t]),i(e).parents(".jtox-kit").each(function(){var e=n.kit(this);e&&!s&&(!t||e instanceof t)&&(s=e)}),s},initTemplates:function(){var t=this,e=i(".jtox-template")[0];e||(e=document.createElement("div"),e.className="jtox-template",document.body.appendChild(e));var n=e.innerHTML;for(var s in t.templates)n+=t.templates[s];e.innerHTML=n,t.templateRoot=e},insertTool:function(t,e){var i=this.tools[t];return null!=i&&(e.innerHTML=i,this.init(e)),e},installHandlers:function(e,i){null==i&&(i=e.rootElement),t.$(".jtox-handler",i).each(function(){var i=t.$(this).data("handler"),n=null;null!=e.settings.configuration&&null!=e.settings.configuration.handlers&&(n=e.settings.configuration.handlers[i]),n=n||window[i],n?"INPUT"==this.tagName||"SELECT"==this.tagName||"TEXTAREA"==this.tagName?t.$(this).on("change",n).on("keydown",t.ui.enterBlur):t.$(this).on("click",n):console.log("jToxQuery: referring unknown handler: "+i)})}}),t.ListWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.length=0,this.clearItems()},t.ListWidget.prototype={itemId:"id",populate:function(t,e){this.items=t,this.length=t.length,this.target.empty();for(var i=0,n=t.length;i<n;i++)this.target.append(this.renderItem("function"==typeof e?e(t[i]):t[i]))},addItem:function(t){return this.items.push(t),++this.length,this.renderItem(t)},clearItems:function(){this.target.empty(),this.items=[],this.length=0},findItem:function(t){var i=this;return e.findIndex(this.items,"string"!=typeof t?t:function(e){return e[i.itemId]===t})},eraseItem:function(t){var e=this.findItem(t),i=e>=0&&this.items.splice(e,1)[0];return this.length=this.items.length,i},enumerateItems:function(t){for(var e=this.target.children(),i=0,n=this.items.length;i<n;++i)t.call(e[i],this.items[i])}},t.TagWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.subtarget&&(this.target=this.target.find(this.subtarget).eq(0)),this.id=t.id,this.color=this.color||this.target.data("color"),this.color&&this.target.addClass(this.color)},t.TagWidget.prototype={__expects:["hasValue","clickHandler"],color:null,renderItem:null,onUpdated:null,subtarget:null,init:function(i){e.pass(this,t.TagWidget,"init",i),this.manager=i},populate:function(t,i){var n,s,a,r=this,o=null,l=0;if(null==t.length||0==t.length)i||this.target.html("No items found in this selection").addClass("jt-no-tags");else{t.sort(function(t,e){return(t.value||t.val)<(e.value||e.val)?-1:1}),i||this.target.empty();for(var h=0,u=t.length;h<u;h++)o=t[h],a=o.value||o.val,s=this.exclusion&&this.hasValue(a),l+=o.count,o.title=a.toString(),"function"==typeof this.modifyTag&&(o=this.modifyTag(o)),s||(o.onMain=r.clickHandler(a)),this.target.append(n=this.renderItem(o)),s&&n.addClass("selected")}e.act(this,this.onUpdated,l)}};var n={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,"json.nl":"map",echoParams:"none"};t.AutocompleteWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.id=t.id,this.lookupMap=t.lookupMap||{},this.fqName=this.useJson?"json.filter":"fq",this.spyManager=new t.SpyManager({parameters:e.extend(!0,n,t.parameters)});var s=this;e.each(t.groups,function(t){s.spyManager.addParameter("facet.field",t.field,e.extend(!0,{key:t.id},t.facet.domain))})},t.AutocompleteWidget.prototype={__expects:["addValue"],servlet:"autophrase",useJson:!1,maxResults:30,groups:null,init:function(n){e.pass(this,t.AutocompleteWidget,"init",n),this.manager=n;var s=this;null==n.getParameter("q").value&&s.addValue(""),s.findBox=this.target.find("input").on("change",function(t){var e=i(this);s.addValue(e.val())&&!s.requestSent&&(e.blur().autocomplete("disable"),n.doRequest())}),s.findBox.autocomplete({minLength:0,source:function(t,e){s.reportCallback=e,s.makeRequest(t.term,function(t){s.onResponse(t)},function(t,i,n){e(["Err : '"+i+"!"])})},select:function(t,e){e.item&&(s.requestSent=!0,n.getListener(e.item.id).addValue(e.item.value)&&n.doRequest())}})},makeRequest:function(t,i,n){var s=this.manager.getParameter(this.fqName);this.spyManager.removeParameters("fq");for(var a=0,r=s.length;a<r;++a)this.spyManager.addParameter("fq",s[a].value);this.spyManager.addParameter("q",t||"*:*");var o=e.extend(o,this.manager.ajaxSettings,this.spyManager.prepareQuery());return o.url=this.manager.solrUrl+(this.servlet||this.manager.servlet)+o.url+"&wt=json&json.wrf=?",o.success=i,o.error=n,this.manager.connector.ajax(o)},onResponse:function(t){var i=this,n=[];e.each(this.groups,function(e){if(!(n.length>=i.maxResults))for(var s in t.facet_counts.facet_fields[e.id])if(n.push({id:e.id,value:s,label:(i.lookupMap[s]||s)+" ("+t.facet_counts.facet_fields[e.id][s]+") - "+e.id}),n.length>=i.maxResults)break}),"function"==typeof this.reportCallback&&i.reportCallback(n)},afterRequest:function(t){var e=this.manager.getParameter("q").value;this.findBox.val("*:*"!=e&&e.length>0?e:"").autocomplete("enable"),this.requestSent=!1}},t.SimpleItemWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target)},t.SimpleItemWidget.prototype={template:null,classes:null,renderItem:function(e){return t.ui.fillTemplate(template,e).addClass(this.classes)}},t.AccordionExpansion=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.header=null,this.id=t.id,this.automatic&&(t.target=this.makeExpansion())},t.AccordionExpansion.prototype={automatic:!0,title:null,classes:null,expansionTemplate:null,before:null,renderExpansion:function(e){return t.ui.fillTemplate(this.expansionTemplate,e).addClass(this.classes)},makeExpansion:function(t,e){if(!this.header){e||(e=this),t||(t=this.before);var n=this.renderExpansion(e);return this.accordion=this.target,t?"number"==typeof t?this.accordion.children().eq(t).before(n):"string"==typeof t?i(t,this.accordion[0]).before(n):i(t).before(n):this.accordion.append(n),this.refresh(),this.header=i("#"+this.id+"_header"),this.target=i("#"+this.id)}},getHeaderText:function(){return this.header.contents().filter(function(){return 3==this.nodeType})[0]},refresh:function(){this.accordion.accordion("refresh")}},t.SliderWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.prepareLimits(t.limits),null==this.initial&&(this.initial=this.isRange?[this.limits[0],this.limits[1]]:(this.limits[0]+this.limits[1])/2),this.target.val(Array.isArray(this.initial)?this.initial.join(","):this.initial),this.automatic&&this.makeSlider()},t.SliderWidget.prototype={__expects:["updateHandler"],limits:null,units:null,initial:null,title:null,width:null,automatic:!0,isRange:!0,showScale:!0,format:"%s {{units}}",prepareLimits:function(t){this.limits="string"==typeof t?t.split(","):t,this.limits[0]=parseFloat(this.limits[0]),this.limits[1]=parseFloat(this.limits[1]),this.precision=Math.pow(10,parseInt(Math.min(1,Math.floor(Math.log10(this.limits[1]-this.limits[0]+1)-3)))),this.precision<1&&this.precision>.01&&(this.precison=.01)},updateSlider:function(t,e){Array.isArray(t)&&(t=t.join(",")),null!=e?(this.prepareLimits(e),this.target.jRange("updateRange",this.limits,t)):this.target.jRange("setValue",t)},makeSlider:function(){var e=this,i=this.limits[1]>this.limits[0],n=[t.ui.formatNumber(this.limits[0],this.precision),this.title+(i||!this.units?"":" ("+this.units+")"),t.ui.formatNumber(this.limits[1],this.precision)],s=e.updateHandler(),a={from:this.limits[0],to:this.limits[1],step:this.precision,scale:n,showScale:this.showScale,showLabels:i,disable:!i,isRange:this.isRange,width:this.width,format:t.ui.formatString(this.format,this)||""};return null!=this.color&&(a.theme="theme-"+this.color),a.ondragend=function(t){return"string"==typeof t&&e.isRange&&(t=t.split(",")),t=Array.isArray(t)?t.map(function(t){return parseFloat(t)}):parseFloat(t),s(t)},this.target.jRange(a)}}}(jToxKit,asSys,jQuery);
