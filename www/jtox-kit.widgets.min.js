!function(t,e,i){t.ui=e.extend(t.ui,{fillTemplate:function(e,a){return i(t.ui.formatString(i(e).html(),a).replace(/(<img(\s+.*)?)(\s+jt-src=")/,'$1 src="')).removeAttr("id")},updateCounter:function(t,e,i){var a=null,n="";return null==e&&(e=0),null==i?(a=/\(([\d\?]+)\)$/,n=""+e):(a=/\(([\d\?]+\/[\d\?\+-]+)\)$/,n=""+e+"/"+i),t.match(a)?t=t.replace(a,"("+n+")"):t+=" ("+n+")",t}}),t.ListWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=t.target,this.length=0,this.clearItems()},t.ListWidget.prototype={itemId:"id",populate:function(t,e){this.items=t,this.length=t.length,i(this.target).empty();for(var a=0,n=t.length;a<n;a++)i(this.target).append(this.renderItem("function"==typeof e?e(t[a]):t[a]))},addItem:function(t){return this.items.push(t),++this.length,this.renderItem(t)},clearItems:function(){i(this.target).empty(),this.items=[],this.length=0},findItem:function(t){var i=this;return e.findIndex(this.items,"string"!=typeof t?t:function(e){return e[i.itemId]===t})},eraseItem:function(t){var e=this.findItem(t),i=e>=0&&this.items.splice(e,1)[0];return this.length=this.items.length,i},enumerateItems:function(t){for(var e=i(this.target).children(),a=0,n=this.items.length;a<n;++a)t.call(e[a],this.items[a])}},t.TagWidget=function(t){e.extend(!0,this,e.common(t,this)),this.nesting&&(this.facet.domain=e.extend(this.facet.domain,{blockChildren:this.nesting})),this.target=i(t.target),this.header=i(t.header),this.id=t.id,this.color=this.color||this.target.data("color")},t.TagWidget.prototype={__expects:["hasValue","clickHandler","getFacetCounts"],color:null,renderTag:null,nesting:null,init:function(i){e.pass(this,t.TagWidget,"init",i),this.manager=i},afterTranslation:function(i){e.pass(this,t.TagWidget,"afterTranslation");var a,n,s=this,r=this.getFacetCounts(i.facets),o=null,l=0,h=getHeaderText(this.header),u=this.header.data("refreshPanel");if(r.sort(function(t,e){return t.val<e.val?-1:1}),0==r.length)this.target.html("No items found in current selection");else{this.target.empty();for(var c=0,d=r.length;c<d;c++)o=r[c],n=this.hasValue(o.val),l+=o.count,o.title=o.val.toString(),"function"==typeof this.modifyTag&&(o=this.modifyTag(o)),n||(o.onMain=s.clickHandler(o.val)),this.target.append(a=this.renderTag(o)),n&&a.addClass("selected")}h.textContent=t.ui.updateCounter(h.textContent,l),u&&u.call()}};var a={facet:!0,rows:0,fl:"id","facet.limit":-1,"facet.mincount":1,"json.nl":"map",echoParams:"none"};t.AutocompleteWidget=function(t){e.extend(!0,this,e.common(t,this)),this.target=i(t.target),this.delayed=null,this.fqName=this.useJson?"json.filter":"fq",this.spyManager=new t.SpyManager({parameters:e.extend(!0,a,t.parameters)});var n=this;e.each(t.facetFields,function(t,i){n.spyManager.addParameter("facet.field",t.field,e.extend(!0,{key:i},t.facet.domain))})},t.AutocompleteWidget.prototype={__expects:["doRequest","set"],servlet:"autophrase",useJson:!1,maxResults:30,facetFields:{},init:function(a){e.pass(this,t.AutocompleteWidget,"init",a),this.manager=a;var n=this;n.findBox=this.target.find("input").on("change",function(t){var e=i(this);n.set(e.val())&&!n.requestSent&&(e.blur().autocomplete("disable"),n.manager.doRequest())}),n.findBox.autocomplete({minLength:0,source:function(t,e){n.reportCallback=e,n.makeRequest(t.term,function(t){n.onResponse(t)},function(t,i,a){e(["Err : '"+i+"!"])})},select:function(t,e){e.item&&(n.requestSent=!0,a.getListener(e.item.id).addValue(e.item.value)&&a.doRequest())}})},makeRequest:function(t,i,a){var n=this.manager.getParameter(this.fqName);this.spyManager.removeParameters("fq");for(var s=0,r=n.length;s<r;++s)this.spyManager.addParameter("fq",n[s].value);this.spyManager.addParameter("q",t||"*:*");var o=e.extend(o,this.manager.ajaxSettings,this.spyManager.prepareQuery());return o.url=this.manager.solrUrl+(this.servlet||this.manager.servlet)+o.url+"&wt=json&json.wrf=?",o.success=i,o.error=a,this.manager.connector.ajax(o)},onResponse:function(t){var i=this,a=[];e.each(this.facetFields,function(e,n){if(!(a.length>=i.maxResults))for(var s in t.facet_counts.facet_fields[n])if(a.push({id:n,value:s,label:(lookup[s]||s)+" ("+t.facet_counts.facet_fields[n][s]+") - "+n}),a.length>=i.maxResults)break}),"function"==typeof this.reportCallback&&i.reportCallback(a)},afterRequest:function(t){var e=this.manager.getParameter("q").value;this.findBox.val("*:*"!=e&&e.length>0?e:"").autocomplete("enable"),this.requestSent=!1}}}(jToxKit,asSys,jQuery);
